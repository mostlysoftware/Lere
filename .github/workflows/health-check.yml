name: Scheduled Health Check

on:
  # Run weekly on Sundays at 6am UTC
  schedule:
    - cron: '0 6 * * 0'
  
  # Also run on demand
  workflow_dispatch:
    inputs:
      scope:
        description: 'Scope to check'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - project
          - scripts
          - plugins
          - context
      create_issue:
        description: 'Create issue for findings'
        required: false
        default: true
        type: boolean

jobs:
  health-check:
    runs-on: windows-latest
    permissions:
      contents: read
      issues: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run health check
        id: health
        shell: pwsh
        run: |
          $scope = "${{ github.event.inputs.scope }}"
          if (-not $scope) { $scope = "all" }
          
          # Run health check with markdown output
          $report = pwsh ./scripts/health_check.ps1 -Scope $scope -Report markdown 2>&1
          $reportText = $report -join "`n"
          
          # Save report to file for artifact
          $reportText | Out-File -FilePath health-report.md -Encoding utf8
          
          # Extract summary counts
          $errors = 0
          $warnings = 0
          if ($reportText -match 'Errors \| (\d+)') { $errors = [int]$Matches[1] }
          if ($reportText -match 'Warnings \| (\d+)') { $warnings = [int]$Matches[1] }
          
          # Set outputs
          echo "errors=$errors" >> $env:GITHUB_OUTPUT
          echo "warnings=$warnings" >> $env:GITHUB_OUTPUT
          echo "has_issues=$($errors -gt 0 -or $warnings -gt 5)" >> $env:GITHUB_OUTPUT

      - name: Upload health report
        uses: actions/upload-artifact@v4
        with:
          name: health-report
          path: health-report.md
          retention-days: 30

      - name: Create issue for significant findings
        if: steps.health.outputs.has_issues == 'true' && (github.event.inputs.create_issue == 'true' || github.event_name == 'schedule')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('health-report.md', 'utf8');
            
            // Check for existing open health check issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'health-check',
              state: 'open'
            });
            
            const title = `ðŸ¥ Health Check: ${${{ steps.health.outputs.errors }}} errors, ${${{ steps.health.outputs.warnings }}} warnings`;
            const body = `## Automated Health Check Report\n\n**Run Date:** ${new Date().toISOString()}\n**Triggered by:** ${context.eventName}\n\n${report}`;
            
            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                title: title,
                body: body
              });
              console.log(`Updated existing issue #${issues.data[0].number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['health-check', 'automated']
              });
              console.log('Created new health check issue');
            }

      - name: Fail on errors
        if: steps.health.outputs.errors > 0
        shell: pwsh
        run: |
          Write-Host "::error::Health check found ${{ steps.health.outputs.errors }} errors"
          exit 1
